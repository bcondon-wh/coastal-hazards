<changeSet author="jiwalker" id="1372109304375-1">
    <createSequence sequenceName="hibernate_sequence"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-2">
    <createTable tableName="session_item">
        <column name="session_id" type="VARCHAR(40)">
            <constraints nullable="false"/>
        </column>
        <column name="item_id" type="VARCHAR(10)">
            <constraints nullable="false"/>
        </column>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-3">
    <createTable tableName="summary">
        <column name="id" type="INT4">
            <constraints nullable="false"/>
        </column>
        <column name="full_text" type="VARCHAR(1023)"/>
        <column name="medium" type="VARCHAR(1023)"/>
        <column name="tiny" type="VARCHAR(255)"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-4">
    <createTable tableName="authorized_users">
        <column name="id" type="INT8">
            <constraints nullable="false"/>
        </column>
        <column name="email" type="VARCHAR(255)"/>
        <column name="name" type="VARCHAR(255)"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-5">
    <createTable tableName="session_table">
        <column name="id" type="VARCHAR(255)">
            <constraints nullable="false"/>
        </column>
        <column name="map_base_layer" type="VARCHAR(255)"/>
        <column name="bounding_box" type="BYTEA"/>
        <column name="center" type="BYTEA"/>
        <column name="scale" type="FLOAT8"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-6">
    <createTable tableName="spatial_ref_sys">
        <column name="srid" type="INT4">
            <constraints nullable="false"/>
        </column>
        <column name="auth_name" type="VARCHAR(256)"/>
        <column name="auth_srid" type="INT4"/>
        <column name="srtext" type="VARCHAR(2048)"/>
        <column name="proj4text" type="VARCHAR(2048)"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-7">
    <createTable tableName="activity">
        <column name="id" type="INT8">
            <constraints nullable="false"/>
        </column>
        <column name="activity_timestamp" type="TIMESTAMP WITH TIME ZONE"/>
        <column name="itemid" type="VARCHAR(10)"/>
        <column name="type" type="INT4"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-8">
    <createTable tableName="item">
        <column name="id" type="VARCHAR(255)">
            <constraints nullable="false"/>
        </column>
        <column name="attr" type="VARCHAR(255)"/>
        <column name="bbox" type="BYTEA"/>
        <column name="metadata" type="VARCHAR(255)"/>
        <column name="name" type="VARCHAR(255)"/>
        <column name="type" type="VARCHAR(255)"/>
        <column name="wfsservice" type="BYTEA"/>
        <column name="wmsservice" type="BYTEA"/>
        <column name="summary_id" type="INT4"/>
        <column name="rank_id" type="VARCHAR(255)"/>
    </createTable>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-9">
    <addPrimaryKey columnNames="id" constraintName="authorized_users_pkey" tableName="authorized_users"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-10">
    <addPrimaryKey columnNames="id" constraintName="activity_pkey" tableName="activity"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-11">
    <addPrimaryKey columnNames="id" constraintName="item_pkey" tableName="item"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-12">
    <addPrimaryKey columnNames="id" constraintName="session_table_pkey" tableName="session_table"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-13">
    <addPrimaryKey columnNames="id" constraintName="summary_pkey" tableName="summary"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-14">
    <addPrimaryKey columnNames="srid" constraintName="spatial_ref_sys_pkey" tableName="spatial_ref_sys"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-15">
    <addForeignKeyConstraint baseColumnNames="summary_id" baseTableName="item" constraintName="fk_q73aomo0x4nf4hyaqsy11jcwh" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="summary"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-16">
    <addForeignKeyConstraint baseColumnNames="item_id" baseTableName="session_item" constraintName="fk_i1wo4o1lv7x8ijsukjrk4a049" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="item"/>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-17">
    <createView viewName="geography_columns">SELECT current_database() AS f_table_catalog, n.nspname AS f_table_schema, c.relname AS f_table_name, a.attname AS f_geography_column, postgis_typmod_dims(a.atttypmod) AS coord_dimension, postgis_typmod_srid(a.atttypmod) AS srid, postgis_typmod_type(a.atttypmod) AS type FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n WHERE (((((((t.typname = 'geography'::name) AND (a.attisdropped = false)) AND (a.atttypid = t.oid)) AND (a.attrelid = c.oid)) AND (c.relnamespace = n.oid)) AND (NOT pg_is_other_temp_schema(c.relnamespace))) AND has_table_privilege(c.oid, 'SELECT'::text));</createView>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-18">
    <createView viewName="ranking">SELECT overall_ranking.id, overall_ranking.total_score FROM (SELECT score_by_id_and_pop_type.id, sum(score_by_id_and_pop_type.activity_type_score) AS total_score FROM (SELECT id_days.id, id_days.type, CASE WHEN (id_days.type = 0) THEN LEAST(sum((((id_days.life_span)::double precision - id_days.days_ago) * (id_days.multiplier)::double precision)), (1000)::double precision) WHEN (id_days.type = 1) THEN LEAST(sum((((id_days.life_span)::double precision - id_days.days_ago) * (id_days.multiplier)::double precision)), (1000)::double precision) WHEN (id_days.type = 2) THEN LEAST(sum((((id_days.life_span)::double precision - id_days.days_ago) * (id_days.multiplier)::double precision)), (800)::double precision) WHEN (id_days.type = 3) THEN LEAST(sum((((id_days.life_span)::double precision - id_days.days_ago) * (id_days.multiplier)::double precision)), (1200)::double precision) WHEN (id_days.type = 4) THEN LEAST(sum((((id_days.life_span)::double precision - id_days.days_ago) * (id_days.multiplier)::double precision)), (500)::double precision) WHEN (id_days.type = 5) THEN (0)::double precision ELSE NULL::double precision END AS activity_type_score FROM (SELECT activity.itemid AS id, (date_part('epoch'::text, (now() - (activity.activity_timestamp)::timestamp with time zone)) / (86400)::double precision) AS days_ago, activity.type, CASE WHEN (activity.type = 0) THEN 1 WHEN (activity.type = 1) THEN 2 WHEN (activity.type = 2) THEN 75 WHEN (activity.type = 3) THEN 100 WHEN (activity.type = 4) THEN 50 WHEN (activity.type = 5) THEN 0 ELSE NULL::integer END AS multiplier, CASE WHEN (activity.type = 0) THEN 7 WHEN (activity.type = 1) THEN 10 WHEN (activity.type = 2) THEN 5 WHEN (activity.type = 3) THEN 14 WHEN (activity.type = 4) THEN 14 WHEN (activity.type = 5) THEN 0 ELSE NULL::integer END AS life_span FROM activity WHERE ((date_part('epoch'::text, (now() - (activity.activity_timestamp)::timestamp with time zone)) / (86400)::double precision) &lt;= (14)::double precision)) id_days WHERE (((((((id_days.type = 0) AND (id_days.days_ago &lt;= (id_days.life_span)::double precision)) OR ((id_days.type = 1) AND (id_days.days_ago &lt;= (id_days.life_span)::double precision))) OR ((id_days.type = 2) AND (id_days.days_ago &lt;= (id_days.life_span)::double precision))) OR ((id_days.type = 3) AND (id_days.days_ago &lt;= (id_days.life_span)::double precision))) OR ((id_days.type = 4) AND (id_days.days_ago &lt;= (id_days.life_span)::double precision))) OR (id_days.type = 5)) GROUP BY id_days.id, id_days.type) score_by_id_and_pop_type GROUP BY score_by_id_and_pop_type.id) overall_ranking ORDER BY overall_ranking.total_score DESC;</createView>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-19">
    <createView viewName="raster_columns">SELECT current_database() AS r_table_catalog, n.nspname AS r_table_schema, c.relname AS r_table_name, a.attname AS r_raster_column, COALESCE(_raster_constraint_info_srid(n.nspname, c.relname, a.attname), (SELECT st_srid('010100000000000000000000000000000000000000'::geometry) AS st_srid)) AS srid, _raster_constraint_info_scale(n.nspname, c.relname, a.attname, 'x'::bpchar) AS scale_x, _raster_constraint_info_scale(n.nspname, c.relname, a.attname, 'y'::bpchar) AS scale_y, _raster_constraint_info_blocksize(n.nspname, c.relname, a.attname, 'width'::text) AS blocksize_x, _raster_constraint_info_blocksize(n.nspname, c.relname, a.attname, 'height'::text) AS blocksize_y, COALESCE(_raster_constraint_info_alignment(n.nspname, c.relname, a.attname), false) AS same_alignment, COALESCE(_raster_constraint_info_regular_blocking(n.nspname, c.relname, a.attname), false) AS regular_blocking, _raster_constraint_info_num_bands(n.nspname, c.relname, a.attname) AS num_bands, _raster_constraint_info_pixel_types(n.nspname, c.relname, a.attname) AS pixel_types, _raster_constraint_info_nodata_values(n.nspname, c.relname, a.attname) AS nodata_values, _raster_constraint_info_out_db(n.nspname, c.relname, a.attname) AS out_db, _raster_constraint_info_extent(n.nspname, c.relname, a.attname) AS extent FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n WHERE (((((((t.typname = 'raster'::name) AND (a.attisdropped = false)) AND (a.atttypid = t.oid)) AND (a.attrelid = c.oid)) AND (c.relnamespace = n.oid)) AND ((c.relkind = 'r'::"char") OR (c.relkind = 'v'::"char"))) AND (NOT pg_is_other_temp_schema(c.relnamespace)));</createView>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-20">
    <createView viewName="geometry_columns">SELECT (current_database())::character varying(256) AS f_table_catalog, (n.nspname)::character varying(256) AS f_table_schema, (c.relname)::character varying(256) AS f_table_name, (a.attname)::character varying(256) AS f_geometry_column, COALESCE(NULLIF(postgis_typmod_dims(a.atttypmod), 2), postgis_constraint_dims((n.nspname)::text, (c.relname)::text, (a.attname)::text), 2) AS coord_dimension, COALESCE(NULLIF(postgis_typmod_srid(a.atttypmod), 0), postgis_constraint_srid((n.nspname)::text, (c.relname)::text, (a.attname)::text), 0) AS srid, (replace(replace(COALESCE(NULLIF(upper(postgis_typmod_type(a.atttypmod)), 'GEOMETRY'::text), (postgis_constraint_type((n.nspname)::text, (c.relname)::text, (a.attname)::text))::text, 'GEOMETRY'::text), 'ZM'::text, ''::text), 'Z'::text, ''::text))::character varying(30) AS type FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n WHERE (((((((((t.typname = 'geometry'::name) AND (a.attisdropped = false)) AND (a.atttypid = t.oid)) AND (a.attrelid = c.oid)) AND (c.relnamespace = n.oid)) AND ((c.relkind = 'r'::"char") OR (c.relkind = 'v'::"char"))) AND (NOT pg_is_other_temp_schema(c.relnamespace))) AND (NOT ((n.nspname = 'public'::name) AND (c.relname = 'raster_columns'::name)))) AND has_table_privilege(c.oid, 'SELECT'::text));</createView>
</changeSet>
<changeSet author="jiwalker" id="1372109304375-21">
    <createView viewName="raster_overviews">SELECT current_database() AS o_table_catalog, n.nspname AS o_table_schema, c.relname AS o_table_name, a.attname AS o_raster_column, current_database() AS r_table_catalog, (split_part(split_part(s.consrc, '''::name'::text, 1), ''''::text, 2))::name AS r_table_schema, (split_part(split_part(s.consrc, '''::name'::text, 2), ''''::text, 2))::name AS r_table_name, (split_part(split_part(s.consrc, '''::name'::text, 3), ''''::text, 2))::name AS r_raster_column, (btrim(split_part(s.consrc, ','::text, 2)))::integer AS overview_factor FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n, pg_constraint s WHERE ((((((((((t.typname = 'raster'::name) AND (a.attisdropped = false)) AND (a.atttypid = t.oid)) AND (a.attrelid = c.oid)) AND (c.relnamespace = n.oid)) AND ((c.relkind = 'r'::"char") OR (c.relkind = 'v'::"char"))) AND (s.connamespace = n.oid)) AND (s.conrelid = c.oid)) AND (s.consrc ~~ '%_overview_constraint(%'::text)) AND (NOT pg_is_other_temp_schema(c.relnamespace)));</createView>
</changeSet>